---
title: "ANCOVA analysis"
output:
  pdf_document: default
  html_notebook: default
  html_document: 
    keep_md: yes
---


```{r,fig.width=5,fig.height=3}
library(ggplot2)

data = read.csv('/Users/changc25/Desktop/gene_exp_test.csv')
data
ggplot(data, aes(x=Gene, y=Expression)) + geom_point(aes(colour = Sample))
```

### Fit Individual Sample
```{r}
model_tumor = lm(Expression~Gene, data=data[data$Sample=='tumor',])
model_normal = lm(Expression~Gene, data=data[data$Sample=='normal',])

coef(model_tumor)
coef(model_normal)
```

The tumor sample has  slope = 10.67, intercept = -0.67

The normal sample has slope = 4.67,  intercept =  0.78

### Comparing Two Samples with two different models
```{r}
model1 = lm(Expression~Sample*Gene, data=data)
model2 = lm(Expression~Sample+Gene, data=data)
```

model1 is equivalent to:
**Expression ~ Gene + Sample + Gene:Sample**
And it means the Expression may be affected by three things:

  1. gene (different gene/SNP will cause different gene expression)
  2. sample (tumor sample shifts the y value but does not change the slope. This means tumor may have some effects on the overall expression that is unrelated to the gene.)
  3. gene expression rate is afected by the sample type (different sample has different rate/slope in their gene expression)

model2 assumes the expression may be affected by only the first two as mentioned above, and there is no interaction between sample and gene.
  
  1. default gene expression rate (no matter it's tumor or nomal)
  2. some effect from the sample that has no effect on the gene (could be sampling error from TCGA data or something else)
  
Here we can compare the R^2 to see which model performs better, then we know whether sample has any effect on the gene and how significant that is. Instead of simply looking at the R^2, you can perform statistical test on this two model using **anova** 
```{r}
anova(model1, model2)
```
Basically, the Pr(>F), that's p-value and is small, suggesting this two models are different. And if you look at the R^2 for model1 is better than model2 (below), saying model1 is more correct, and there is sample-gene interaction in this data.

```{r}
print(paste('model1 R^2:', summary(model1)$r.squared))
print(paste('model2 R^2:', summary(model2)$r.squared))
```

### How significant is this sample-gene interaction?
```{r, fig.width=5,fig.height=3}
summary(model1)
ggplot(data, aes(x=Gene, y=Expression, colour = Sample)) + geom_point() +
  geom_abline(intercept = coef(model1)[['(Intercept)']], slope = coef(model1)[['Gene']], color = "red", alpha = 0.7) + 
  geom_abline(intercept = coef(model1)[['(Intercept)']] + coef(model1)[['Sampletumor']], slope = coef(model1)[['Gene']] + coef(model1)[['Sampletumor:Gene']], color = "steelblue3", alpha = 0.8) 
```
From the model_tumor and model_normal, we know:

The tumor sample has  slope = 10.67, intercept = -0.67

The normal sample has slope = 4.67,  intercept =  0.78

The **'Sampletumor:Gene'** is the (tumor slope) - (normal slope). 6 = 10.67 - 4.67. The the p-value is small, saying these two slopes are significally different. 

**'(intercept)'** is the intercept of **normal** sample. 

**'Sampletumor'** is the difference between (tumor intercept) and (normal intercept). -0.67 - 0.78 = -1.45 (or -1.4444)

**'Gene'** is the slope of **normal** sample. 

And from Sampletumor:Gene, we can calculate the slope of tumor sample: 4.6667 + 6.0000 = 10.6667, same as what we got from model_tumor.

```{r, fig.width=5,fig.height=3}
summary(model2)
ggplot(data, aes(x=Gene, y=Expression, colour = Sample)) + geom_point() +
  geom_abline(intercept = coef(model2)[['(Intercept)']], slope = coef(model2)[['Gene']], color = "red", alpha = 0.7) + 
  geom_abline(intercept = coef(model2)[['(Intercept)']] + coef(model2)[['Sampletumor']], slope = coef(model2)[['Gene']], color = "steelblue3", alpha = 0.8) 
```
Model2 assumes there is no interaction between sample and gene, so it uses only one slope to fit these two samples. The fitted slope will close to the average slope of model_tumor and model_normal.

**'(intercept)'** is the intercept of **normal** sample. 

**'Sampletumor'** is the difference between (tumor intercept) and (normal intercept).

**'Gene'** is the average slope of this model (there is only one slope in this model because it assumes there is not interaction between sample and gene). It is close to (10.67 + 4.67) / 2.